<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Proxy and restore — vec_proxy • vctrs</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Proxy and restore — vec_proxy" />
<meta property="og:description" content="
vec_proxy() returns the data structure containing the values of a
vector. This data structure is usually the vector itself. In this
case the proxy is the identity function, which is
the default vec_proxy() method.
Only experts should implement special vec_proxy() methods, for
these cases:
A vector has vectorised attributes, i.e. metadata for
each element of the vector. These record types are implemented
in vctrs by returning a data frame in the proxy method. If you're
starting your class from scratch, consider deriving from the
rcrd class. It implements the appropriate data
frame proxy and is generally the preferred way to create a record
class.
When you're implementing a vector on top of a non-vector type,
like an environment or an S4 object. This is currently only
partially supported.
S3 lists are considered scalars by default. This is the safe
choice for list objects such as returned by stats::lm(). To
declare that your S3 list class is a vector, you normally add
&quot;list&quot; to the right of your class vector. Explicit inheritance
from list is generally the preferred way to declare an S3 list in
R, for instance it makes it possible to dispatch on
generic.list S3 methods.
If you can't modify your class vector, you can implement an
identity proxy (i.e. a proxy method that just returns its input)
to let vctrs know this is a vector list and not a scalar.


vec_restore() is the inverse operation of vec_proxy(). It
should only be called on vector proxies.
It undoes the transformations of vec_proxy().
It restores attributes and classes. These may be lost when the
memory values are manipulated. For example slicing a subset of a
vector's proxy causes a new proxy to be allocated.


By default vctrs restores all attributes and classes
automatically. You only need to implement a vec_restore() method
if your class has attributes that depend on the data." />
<meta property="og:image" content="https://vctrs.r-lib.org/logo.png" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>


  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vctrs</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.5.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/pillar.html">Printing vectors nicely in tibbles</a>
    </li>
    <li>
      <a href="../articles/s3-vector.html">S3 vectors</a>
    </li>
    <li>
      <a href="../articles/stability.html">Type and size stability</a>
    </li>
    <li>
      <a href="../articles/type-size.html">Prototypes and sizes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/r-lib/vctrs/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Proxy and restore</h1>
    <small class="dont-index">Source: <a href='https://github.com/r-lib/vctrs/blob/master/R/proxy.R'><code>R/proxy.R</code></a></small>
    <div class="hidden name"><code>vec_proxy.Rd</code></div>
    </div>

    <div class="ref-description">
    <p><a href='https://www.tidyverse.org/lifecycle/#experimental'><img src='figures/lifecycle-experimental.svg' alt='Experimental lifecycle'></a></p>
<p><code>vec_proxy()</code> returns the data structure containing the values of a
vector. This data structure is usually the vector itself. In this
case the proxy is the <a href='https://rdrr.io/r/base/identity.html'>identity function</a>, which is
the default <code>vec_proxy()</code> method.</p>
<p>Only experts should implement special <code>vec_proxy()</code> methods, for
these cases:</p><ul>
<li><p>A vector has vectorised attributes, i.e. metadata for
each element of the vector. These <em>record types</em> are implemented
in vctrs by returning a data frame in the proxy method. If you're
starting your class from scratch, consider deriving from the
<code><a href='new_rcrd.html'>rcrd</a></code> class. It implements the appropriate data
frame proxy and is generally the preferred way to create a record
class.</p></li>
<li><p>When you're implementing a vector on top of a non-vector type,
like an environment or an S4 object. This is currently only
partially supported.</p></li>
<li><p>S3 lists are considered scalars by default. This is the safe
choice for list objects such as returned by <code><a href='https://rdrr.io/r/stats/lm.html'>stats::lm()</a></code>. To
declare that your S3 list class is a vector, you normally add
<code>"list"</code> to the right of your class vector. Explicit inheritance
from list is generally the preferred way to declare an S3 list in
R, for instance it makes it possible to dispatch on
<code>generic.list</code> S3 methods.</p>
<p>If you can't modify your class vector, you can implement an
identity proxy (i.e. a proxy method that just returns its input)
to let vctrs know this is a vector list and not a scalar.</p></li>
</ul>

<p><code>vec_restore()</code> is the inverse operation of <code>vec_proxy()</code>. It
should only be called on vector proxies.</p><ul>
<li><p>It undoes the transformations of <code>vec_proxy()</code>.</p></li>
<li><p>It restores attributes and classes. These may be lost when the
memory values are manipulated. For example slicing a subset of a
vector's proxy causes a new proxy to be allocated.</p></li>
</ul>

<p>By default vctrs restores all attributes and classes
automatically. You only need to implement a <code>vec_restore()</code> method
if your class has attributes that depend on the data.</p>
    </div>

    <pre class="usage"><span class='fu'>vec_proxy</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>...</span><span class='op'>)</span>

<span class='fu'>vec_restore</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>to</span>, <span class='va'>...</span>, n <span class='op'>=</span> <span class='cn'>NULL</span><span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>x</th>
      <td><p>A vector.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>These dots are for future extensions and must be empty.</p></td>
    </tr>
    <tr>
      <th>to</th>
      <td><p>The original vector to restore to.</p></td>
    </tr>
    <tr>
      <th>n</th>
      <td><p><a href='https://www.tidyverse.org/lifecycle/#experimental'><img src='figures/lifecycle-experimental.svg' alt='Experimental lifecycle'></a>

The total size to restore to. This is currently passed by
<code><a href='vec_slice.html'>vec_slice()</a></code> to solve edge cases arising in data frame
restoration. In most cases you don't need this information and
can safely ignore that argument. This parameter should be
considered internal and experimental, it might change in the
future.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="proxying"><a class="anchor" href="#proxying"></a>Proxying</h2>

    


<p>You should only implement <code>vec_proxy()</code> when your type is designed
around a non-vector class. I.e. anything that is not either:</p><ul>
<li><p>An atomic vector</p></li>
<li><p>A bare list</p></li>
<li><p>A data frame</p></li>
</ul>

<p>In this case, implement <code>vec_proxy()</code> to return such a vector
class. The vctrs operations such as <code><a href='vec_slice.html'>vec_slice()</a></code> are applied on
the proxy and <code>vec_restore()</code> is called to restore the original
representation of your type.</p>
<p>The most common case where you need to implement <code>vec_proxy()</code> is
for S3 lists. In vctrs, S3 lists are treated as scalars by
default. This way we don't treat objects like model fits as
vectors. To prevent vctrs from treating your S3 list as a scalar,
unclass it in the <code>vec_proxy()</code> method. For instance, here is the
definition for <code>list_of</code>:</p><pre><span class='va'>vec_proxy.vctrs_list_of</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='fu'><a href='https://rdrr.io/r/base/class.html'>unclass</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span>
<span class='op'>}</span>
</pre>

<p>Another case where you need to implement a proxy is <a href='new_rcrd.html'>record types</a>. Record types should return a data frame, as in
the <code>POSIXlt</code> method:</p><pre><span class='va'>vec_proxy.POSIXlt</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='fu'><a href='new_data_frame.html'>new_data_frame</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/class.html'>unclass</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>
</pre>

<p>Note that you don't need to implement <code>vec_proxy()</code> when your class
inherits from <code>vctrs_vctr</code> or <code>vctrs_rcrd</code>.</p>
    <h2 class="hasAnchor" id="restoring"><a class="anchor" href="#restoring"></a>Restoring</h2>

    


<p>A restore is a specialised type of cast, primarily used in
conjunction with <code><a href='https://rdrr.io/r/base/UseMethod.html'>NextMethod()</a></code> or a C-level function that works on
the underlying data structure. A <code>vec_restore()</code> method can make
the following assumptions about <code>x</code>:</p><ul>
<li><p>It has the correct type.</p></li>
<li><p>It has the correct names.</p></li>
<li><p>It has the correct <code>dim</code> and <code>dimnames</code> attributes.</p></li>
<li><p>It is unclassed. This way you can call vctrs generics with <code>x</code>
without triggering an infinite loop of restoration.</p></li>
</ul>

<p>The length may be different (for example after <code><a href='vec_slice.html'>vec_slice()</a></code> has
been called), and all other attributes may have been lost. The
method should restore all attributes so that after restoration,
<code>vec_restore(vec_data(x), x)</code> yields <code>x</code>.</p>
<p>To understand the difference between <code><a href='vec_cast.html'>vec_cast()</a></code> and <code>vec_restore()</code>
think about factors: it doesn't make sense to cast an integer to a factor,
but if <code><a href='https://rdrr.io/r/base/UseMethod.html'>NextMethod()</a></code> or another low-level function has stripped attributes,
you still need to be able to restore them.</p>
<p>The default method copies across all attributes so you only need to
provide your own method if your attributes require special care
(i.e. they are dependent on the data in some way). When implementing
your own method, bear in mind that many R users add attributes to track
additional metadata that is important to them, so you should preserve any
attributes that don't require special handling for your class.</p>
    <h2 class="hasAnchor" id="dependencies"><a class="anchor" href="#dependencies"></a>Dependencies</h2>

    

<ul>
<li><p><code>x</code> must be a vector in the vctrs sense (see <code><a href='vec_assert.html'>vec_is()</a></code>)</p></li>
<li><p>By default the underlying data is returned as is (identity proxy)</p></li>
</ul>

<p>All vector classes have a proxy, even those who don't implement any
vctrs methods. The exception is S3 lists that don't inherit from
<code>"list"</code> explicitly. These might have to implement an identity
proxy for compatibility with vctrs (see discussion above).</p>

  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by <a href='http://hadley.nz'>Hadley Wickham</a>, Lionel Henry, Davis Vaughan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


