<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proxy generics • vctrs</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Proxy generics">
<meta property="og:description" content="">
<meta property="og:image" content="https://vctrs.r-lib.org/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vctrs</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/double-dispatch.html">Double dispatch</a>
    </li>
    <li>
      <a href="../articles/function-types.html">Function types</a>
    </li>
    <li>
      <a href="../articles/s3-base.html">Base classes</a>
    </li>
    <li>
      <a href="../articles/s3-proxy.html">Proxy generics</a>
    </li>
    <li>
      <a href="../articles/s3-vector.html">S3 vectors</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/vctrs">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Proxy generics</h1>
            
            <h4 class="date">2018-10-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/vctrs/blob/master/vignettes/s3-proxy.Rmd"><code>vignettes/s3-proxy.Rmd</code></a></small>
      <div class="hidden name"><code>s3-proxy.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(vctrs)</a></code></pre></div>
<p>vctrs provides two “proxy” generics that allow you to declare that your class have possesses certain properties. A proxy function returns a simple object (typically either a bare vector or a data frame), that possesses the same properties as your class. This permits efficient implementation of the vctrs internals because once you have the proxy object, all code can be written in C.</p>
<ul>
<li><p><code><a href="../reference/vec_proxy_equal.html">vec_proxy_equal()</a></code> specifies how to test the elements of your for equality. This proxy underpins <code>==</code> and <code>!=</code>, but also <code>unique()</code>, <code>anyDuplicated()</code>, and <code>is.na()</code>.</p></li>
<li><p><code><a href="../reference/vec_proxy_compare.html">vec_proxy_compare()</a></code> specifies how to compare the elements of your vector. This proxy is used in <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;=</code>, <code>&gt;</code>, <code>min()</code>, <code>max()</code>, <code>median()</code>, <code>quantile()</code>, and <code>xtfrm()</code> methods. (And <code>xtfrm()</code> is used in <code>order()</code> and <code>sort()</code>.)</p></li>
</ul>
<p>vctrs also provides two mathematical generics that allow you to define a broad swath of mathematical behaviour at once:</p>
<ul>
<li><p><code><a href="../reference/vec_math.html">vec_math()</a></code> specifies the behaviour of mathematical functions like <code>abs()</code>, <code>sum()</code>, and <code>mean()</code>.</p></li>
<li><p><code><a href="../reference/vec_arith.html">vec_arith()</a></code> specifies the behaviour of the arithmetic operations like <code>+</code>, <code>-</code>, and <code>%%</code>.</p></li>
</ul>
<p>Where possible, it’s a good idea to define methods for these generics because you get a lot of behaviour for relatively little work.</p>
<div id="rational" class="section level2">
<h2 class="hasAnchor">
<a href="#rational" class="anchor"></a>Rational</h2>
<p>To explore these ideas we’ll use the rational class which was introduced in <code><a href="../articles/s3-vector.html">vignette("s3-vector")</a></code>. Here’s the basic defintion of the class:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">new_rational &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">n =</span> <span class="kw">integer</span>(), <span class="dt">d =</span> <span class="kw">integer</span>()) {</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="kw">stopifnot</span>(<span class="kw">is.integer</span>(n))</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">  <span class="kw">stopifnot</span>(<span class="kw">is.integer</span>(d))</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  <span class="kw"><a href="../reference/new_rcrd.html">new_rcrd</a></span>(<span class="kw">list</span>(<span class="dt">n =</span> n, <span class="dt">d =</span> d), <span class="dt">class =</span> <span class="st">"vctrs_rational"</span>)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">rational &lt;-<span class="st"> </span><span class="cf">function</span>(n, d) {</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">  <span class="kw">c</span>(n, d) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">as.list</span>(<span class="kw"><a href="../reference/vec_coerce.html">vec_coerce</a></span>(n, d, <span class="dt">.ptype =</span> <span class="kw">integer</span>()))</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">  <span class="kw">c</span>(n, d) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw"><a href="../reference/vec_recycle.html">vec_recycle</a></span>(n, d)</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">  <span class="kw">new_rational</span>(n, d)</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">format.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">  n &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"n"</span>)</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">  d &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"d"</span>)</a>
<a class="sourceLine" id="cb2-16" data-line-number="16">  </a>
<a class="sourceLine" id="cb2-17" data-line-number="17">  out &lt;-<span class="st"> </span><span class="kw">paste0</span>(n, <span class="st">"/"</span>, d)</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">  out[<span class="kw">is.na</span>(n) <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(d)] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19">  </a>
<a class="sourceLine" id="cb2-20" data-line-number="20">  out</a>
<a class="sourceLine" id="cb2-21" data-line-number="21">}</a>
<a class="sourceLine" id="cb2-22" data-line-number="22"></a>
<a class="sourceLine" id="cb2-23" data-line-number="23">vec_ptype_abbr.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="st">"rtnl"</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24">vec_ptype_full.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="st">"rational"</span></a></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">vec_type2.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">UseMethod</span>(<span class="st">"vec_type2.vctrs_rational"</span>, y)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">vec_type2.vctrs_rational.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_type</a></span>(x, y)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">vec_type2.vctrs_rational.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) x</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">vec_cast.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw">UseMethod</span>(<span class="st">"vec_cast.vctrs_rational"</span>)</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">vec_cast.vctrs_rational.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_cast</a></span>(x, y)</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">vec_cast.vctrs_rational.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) x</a></code></pre></div>
<div id="equality" class="section level3">
<h3 class="hasAnchor">
<a href="#equality" class="anchor"></a>Equality</h3>
<p>By default, <code><a href="../reference/vec_proxy_equal.html">vec_proxy_equal()</a></code> converts a record to a data frame:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">rational</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">x</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">#&gt; &lt;rational[4]&gt;</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#&gt; [1] 1/1 2/1 1/2 2/2</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="kw"><a href="../reference/vec_proxy_equal.html">vec_proxy_equal</a></span>(x)</a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">#&gt;   n d</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">#&gt; 1 1 1</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co">#&gt; 2 2 1</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co">#&gt; 3 1 2</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co">#&gt; 4 2 2</span></a></code></pre></div>
<p>And the default comparison is column by column:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">x <span class="op">==</span><span class="st"> </span><span class="kw">rational</span>(<span class="dv">1</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">#&gt; [1]  TRUE FALSE FALSE FALSE</span></a></code></pre></div>
<p>This is an ok default, but doesn’t do exactly what we want here because <code>rational(1, 1)</code> represents the same number as <code>rational(2, 2)</code> so they should be equal. We can fix that by dividing <code>n</code> and <code>d</code> by their greatest common divisor:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># Thanks to Matthew Lundberg: https://stackoverflow.com/a/21504113/16632 </span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">gcd &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  r &lt;-<span class="st"> </span>x <span class="op">%%</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  <span class="kw">ifelse</span>(r, <span class="kw">gcd</span>(y, r), y)</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">vec_proxy_equal.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">  n &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"n"</span>)</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">  d &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"d"</span>)</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">  gcd &lt;-<span class="st"> </span><span class="kw">gcd</span>(n, d)</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb6-12" data-line-number="12">  <span class="kw">data.frame</span>(<span class="dt">n =</span> n <span class="op">/</span><span class="st"> </span>gcd, <span class="dt">d =</span> d <span class="op">/</span><span class="st"> </span>gcd)</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb6-14" data-line-number="14"><span class="kw"><a href="../reference/vec_proxy_equal.html">vec_proxy_equal</a></span>(x)</a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="co">#&gt;   n d</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="co">#&gt; 1 1 1</span></a>
<a class="sourceLine" id="cb6-17" data-line-number="17"><span class="co">#&gt; 2 2 1</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="co">#&gt; 3 1 2</span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19"><span class="co">#&gt; 4 1 1</span></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"></a>
<a class="sourceLine" id="cb6-21" data-line-number="21">x <span class="op">==</span><span class="st"> </span><span class="kw">rational</span>(<span class="dv">1</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb6-22" data-line-number="22"><span class="co">#&gt; [1]  TRUE FALSE FALSE  TRUE</span></a></code></pre></div>
</div>
<div id="comparison" class="section level3">
<h3 class="hasAnchor">
<a href="#comparison" class="anchor"></a>Comparison</h3>
<p>Again, the default comparison proxy is just the elements:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="../reference/vec_proxy_compare.html">vec_proxy_compare</a></span>(x)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt;   n d</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">#&gt; 1 1 1</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">#&gt; 2 2 1</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&gt; 3 1 2</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&gt; 4 2 2</span></a></code></pre></div>
<p>So sorting doesn’t give us increasing order:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">sort</span>(x)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co">#&gt; &lt;rational[4]&gt;</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co">#&gt; [1] 1/1 1/2 2/1 2/2</span></a></code></pre></div>
<p>Here the easiest fix is to simply compute the fraction and then sort that real number:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">vec_proxy_compare.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">  <span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"n"</span>) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"d"</span>)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="kw">sort</span>(x)</a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">#&gt; &lt;rational[4]&gt;</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co">#&gt; [1] 1/2 1/1 2/2 2/1</span></a></code></pre></div>
<p>(We could have used that technique for equality, but due to floating point computation it’s not necessarily true that <code>x == y</code> implies that <code>d * x == d * y</code>.)</p>
</div>
</div>
<div id="polynomial" class="section level2">
<h2 class="hasAnchor">
<a href="#polynomial" class="anchor"></a>Polynomial</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">new_poly &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  <span class="kw"><a href="../reference/new_list_of.html">new_list_of</a></span>(x, <span class="dt">ptype =</span> <span class="kw">integer</span>(), <span class="dt">class =</span> <span class="st">"vctrs_poly"</span>)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">poly &lt;-<span class="st"> </span><span class="cf">function</span>(...) {</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">  x &lt;-<span class="st"> </span><span class="kw">list</span>(...)</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">  x &lt;-<span class="st"> </span><span class="kw">lapply</span>(x, vec_cast, <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">  <span class="kw">new_poly</span>(x)</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb10-10" data-line-number="10"></a>
<a class="sourceLine" id="cb10-11" data-line-number="11">vec_ptype_full.vctrs_poly &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="st">"polynomial"</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">vec_ptype_abbr.vctrs_poly &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="st">"poly"</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"></a>
<a class="sourceLine" id="cb10-14" data-line-number="14">format.vctrs_poly &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb10-15" data-line-number="15">  format_one &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb10-16" data-line-number="16">    <span class="cf">if</span> (<span class="kw">length</span>(x) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb10-17" data-line-number="17">      <span class="kw">return</span>(<span class="st">""</span>)</a>
<a class="sourceLine" id="cb10-18" data-line-number="18">    } <span class="cf">else</span> <span class="cf">if</span> (<span class="kw">length</span>(x) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb10-19" data-line-number="19">      <span class="kw">format</span>(x)</a>
<a class="sourceLine" id="cb10-20" data-line-number="20">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb10-21" data-line-number="21">      suffix &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">paste0</span>(<span class="st">"\u22C5x^"</span>, <span class="kw">seq</span>(<span class="kw">length</span>(x) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>)), <span class="st">""</span>)</a>
<a class="sourceLine" id="cb10-22" data-line-number="22">      out &lt;-<span class="st"> </span><span class="kw">paste0</span>(x, suffix)</a>
<a class="sourceLine" id="cb10-23" data-line-number="23">      out &lt;-<span class="st"> </span>out[x <span class="op">!=</span><span class="st"> </span>0L]</a>
<a class="sourceLine" id="cb10-24" data-line-number="24">      <span class="kw">paste0</span>(out, <span class="dt">collapse =</span> <span class="st">" + "</span>)</a>
<a class="sourceLine" id="cb10-25" data-line-number="25">    }</a>
<a class="sourceLine" id="cb10-26" data-line-number="26">  }</a>
<a class="sourceLine" id="cb10-27" data-line-number="27">  <span class="kw">vapply</span>(x, format_one, <span class="kw">character</span>(<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb10-28" data-line-number="28">}</a>
<a class="sourceLine" id="cb10-29" data-line-number="29"></a>
<a class="sourceLine" id="cb10-30" data-line-number="30">vec_print_data.vctrs_poly &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb10-31" data-line-number="31">  <span class="cf">if</span> (<span class="kw">length</span>(x) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb10-32" data-line-number="32">    <span class="kw">return</span>()</a>
<a class="sourceLine" id="cb10-33" data-line-number="33">  <span class="kw">print</span>(<span class="kw">format</span>(x), <span class="dt">quote =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb10-34" data-line-number="34">}</a>
<a class="sourceLine" id="cb10-35" data-line-number="35"></a>
<a class="sourceLine" id="cb10-36" data-line-number="36">p &lt;-<span class="st"> </span><span class="kw">poly</span>(<span class="dv">1</span>, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb10-37" data-line-number="37">p</a>
<a class="sourceLine" id="cb10-38" data-line-number="38"><span class="co">#&gt; &lt;polynomial[3]&gt;</span></a>
<a class="sourceLine" id="cb10-39" data-line-number="39"><span class="co">#&gt; [1] 1         1⋅x^2 + 1 1⋅x^4 + 2</span></a></code></pre></div>
<p>Equality works out of the box because we can tell if two integer vectors are equal:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">p <span class="op">==</span><span class="st"> </span><span class="kw">poly</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co">#&gt; [1] FALSE  TRUE FALSE</span></a></code></pre></div>
<p>But we can’t order them, because lists are not comparable:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">sort</span>(p)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="co">#&gt; Error: Invalid type returned by `vec_proxy_compare()`.</span></a></code></pre></div>
<p>So we need to define a <code><a href="../reference/vec_proxy_compare.html">vec_proxy_compare()</a></code> method:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">vec_proxy_compare.vctrs_poly &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">  x_raw &lt;-<span class="st"> </span><span class="kw"><a href="../reference/vec_data.html">vec_data</a></span>(x)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">  <span class="co"># First figure out the maximum length</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">  n &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">vapply</span>(x_raw, length, <span class="kw">integer</span>(<span class="dv">1</span>)))</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb13-6" data-line-number="6">  <span class="co"># Then expand all vectors to this length by filling in with zeros</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">  full &lt;-<span class="st"> </span><span class="kw">lapply</span>(x_raw, <span class="cf">function</span>(x) <span class="kw">c</span>(<span class="kw">rep</span>(0L, n <span class="op">-</span><span class="st"> </span><span class="kw">length</span>(x)), x))</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb13-9" data-line-number="9">  <span class="co"># Then turn into a data frame</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10">  <span class="kw">as.data.frame</span>(<span class="kw">do.call</span>(rbind, full))</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb13-12" data-line-number="12"></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="kw">sort</span>(<span class="kw">poly</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="co">#&gt; &lt;polynomial[3]&gt;</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="co">#&gt; [1] 1 2 3</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="kw">sort</span>(<span class="kw">poly</span>(<span class="dv">1</span>, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>)))</a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="co">#&gt; &lt;polynomial[3]&gt;</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18"><span class="co">#&gt; [1] 1     1⋅x^1 1⋅x^2</span></a></code></pre></div>
</div>
<div id="period-and-frequency" class="section level2">
<h2 class="hasAnchor">
<a href="#period-and-frequency" class="anchor"></a>Period and frequency</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">period &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">  x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(x, <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">  <span class="kw"><a href="../reference/new_vctr.html">new_vctr</a></span>(x, <span class="dt">class =</span> <span class="st">"vctrs_period"</span>)</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">format.vctrs_period &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">  <span class="kw">paste0</span>(<span class="kw">format</span>(<span class="kw"><a href="../reference/vec_data.html">vec_data</a></span>(x)), <span class="st">" s"</span>)</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb14-8" data-line-number="8"></a>
<a class="sourceLine" id="cb14-9" data-line-number="9">freq &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">  x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(x, <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">  <span class="kw"><a href="../reference/new_vctr.html">new_vctr</a></span>(x, <span class="dt">class =</span> <span class="st">"vctrs_frequency"</span>)</a>
<a class="sourceLine" id="cb14-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">format.vctr_frequency &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb14-14" data-line-number="14">  <span class="kw">paste0</span>(<span class="kw">format</span>(<span class="kw"><a href="../reference/vec_data.html">vec_data</a></span>(x)), <span class="st">" Hz"</span>)</a>
<a class="sourceLine" id="cb14-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb14-16" data-line-number="16"></a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="kw">period</span>(<span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb14-18" data-line-number="18"><span class="co">#&gt; &lt;vctrs_period[1]&gt;</span></a>
<a class="sourceLine" id="cb14-19" data-line-number="19"><span class="co">#&gt; [1] 0.1 s</span></a>
<a class="sourceLine" id="cb14-20" data-line-number="20"><span class="kw">freq</span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb14-21" data-line-number="21"><span class="co">#&gt; &lt;vctrs_frequency[1]&gt;</span></a>
<a class="sourceLine" id="cb14-22" data-line-number="22"><span class="co">#&gt; [1] 10</span></a></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">vec_arith.vctr_frequency &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y) {</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">  <span class="kw">UseMethod</span>(<span class="st">"vec_arith.vctr_frequency"</span>, y)</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">vec_arith.vctrs_frequency.default &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y) {</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">  <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_op</a></span>(op, x, y)</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">vec_arith.vctrs_period &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y) {</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">  <span class="kw">UseMethod</span>(<span class="st">"vec_arith.vctrs_period"</span>, y)</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">vec_arith.vctrs_period.default &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y) {</a>
<a class="sourceLine" id="cb15-11" data-line-number="11">  <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_op</a></span>(op, x, y)</a>
<a class="sourceLine" id="cb15-12" data-line-number="12">}</a></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">vec_arith.vctrs_period.vctrs_period &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y) {</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">  <span class="cf">switch</span>(op,</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">    <span class="st">`</span><span class="dt">-</span><span class="st">`</span> =<span class="st"> </span>,</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">    <span class="st">`</span><span class="dt">+</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="../reference/vec_cast.html">vec_restore</a></span>(<span class="kw"><a href="../reference/vec_arith.html">vec_arith_base</a></span>(op, x, y), x),</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">    <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_op</a></span>(op, x, y)</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">  )</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">vec_arith.vctrs_period.numeric &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y) {</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">  <span class="cf">switch</span>(op,</a>
<a class="sourceLine" id="cb16-10" data-line-number="10">    <span class="st">`</span><span class="dt">-</span><span class="st">`</span> =<span class="st"> </span>,</a>
<a class="sourceLine" id="cb16-11" data-line-number="11">    <span class="st">`</span><span class="dt">+</span><span class="st">`</span> =<span class="st"> </span>,</a>
<a class="sourceLine" id="cb16-12" data-line-number="12">    <span class="st">`</span><span class="dt">*</span><span class="st">`</span> =<span class="st"> </span>,</a>
<a class="sourceLine" id="cb16-13" data-line-number="13">    <span class="st">`</span><span class="dt">/</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="../reference/vec_cast.html">vec_restore</a></span>(<span class="kw"><a href="../reference/vec_arith.html">vec_arith_base</a></span>(op, x, y), x),</a>
<a class="sourceLine" id="cb16-14" data-line-number="14">    <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_op</a></span>(op, x, y)</a>
<a class="sourceLine" id="cb16-15" data-line-number="15">  )</a>
<a class="sourceLine" id="cb16-16" data-line-number="16">}</a>
<a class="sourceLine" id="cb16-17" data-line-number="17">vec_arith.numeric.vctrs_period &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y) {</a>
<a class="sourceLine" id="cb16-18" data-line-number="18">  <span class="cf">switch</span>(op,</a>
<a class="sourceLine" id="cb16-19" data-line-number="19">    <span class="st">`</span><span class="dt">*</span><span class="st">`</span> =<span class="st"> </span><span class="kw"><a href="../reference/vec_cast.html">vec_restore</a></span>(<span class="kw"><a href="../reference/vec_arith.html">vec_arith_base</a></span>(op, x, y), y),</a>
<a class="sourceLine" id="cb16-20" data-line-number="20">    <span class="st">`</span><span class="dt">/</span><span class="st">`</span> =<span class="st"> </span><span class="kw">freq</span>(<span class="kw"><a href="../reference/vec_arith.html">vec_arith_base</a></span>(op, x, y)),</a>
<a class="sourceLine" id="cb16-21" data-line-number="21">    <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_op</a></span>(op, x, y)</a>
<a class="sourceLine" id="cb16-22" data-line-number="22">  )</a>
<a class="sourceLine" id="cb16-23" data-line-number="23">}</a>
<a class="sourceLine" id="cb16-24" data-line-number="24"></a>
<a class="sourceLine" id="cb16-25" data-line-number="25"><span class="kw">period</span>(<span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw">period</span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb16-26" data-line-number="26"><span class="co">#&gt; &lt;vctrs_period[1]&gt;</span></a>
<a class="sourceLine" id="cb16-27" data-line-number="27"><span class="co">#&gt; [1] 2 s</span></a>
<a class="sourceLine" id="cb16-28" data-line-number="28"><span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">period</span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb16-29" data-line-number="29"><span class="co">#&gt; &lt;vctrs_period[1]&gt;</span></a>
<a class="sourceLine" id="cb16-30" data-line-number="30"><span class="co">#&gt; [1] 20 s</span></a>
<a class="sourceLine" id="cb16-31" data-line-number="31"><span class="kw">period</span>(<span class="dv">10</span>) <span class="op">/</span><span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb16-32" data-line-number="32"><span class="co">#&gt; &lt;vctrs_period[1]&gt;</span></a>
<a class="sourceLine" id="cb16-33" data-line-number="33"><span class="co">#&gt; [1] 2 s</span></a>
<a class="sourceLine" id="cb16-34" data-line-number="34"><span class="dv">5</span> <span class="op">/</span><span class="st"> </span><span class="kw">period</span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb16-35" data-line-number="35"><span class="co">#&gt; &lt;vctrs_frequency[1]&gt;</span></a>
<a class="sourceLine" id="cb16-36" data-line-number="36"><span class="co">#&gt; [1] 0.5</span></a></code></pre></div>
</div>
<div id="intervals" class="section level2">
<h2 class="hasAnchor">
<a href="#intervals" class="anchor"></a>Intervals</h2>
<p>First, we implement an interval class, a record composed of <code>l</code>eft and <code>r</code>ight fields. As usual, we make a low-level constructor, a user-friend constructor, and define a format method.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">new_interval &lt;-<span class="st"> </span><span class="cf">function</span>(l, r) {</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">  <span class="kw">stopifnot</span>(<span class="kw">is.double</span>(l), <span class="kw">is.double</span>(r))</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">  <span class="kw"><a href="../reference/new_rcrd.html">new_rcrd</a></span>(<span class="kw">list</span>(<span class="dt">l =</span> l, <span class="dt">r =</span> r), <span class="dt">class =</span> <span class="st">"vctrs_interval"</span>)</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">interval &lt;-<span class="st"> </span><span class="cf">function</span>(l, r) {</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">  <span class="kw">c</span>(l, r) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">as.list</span>(<span class="kw"><a href="../reference/vec_coerce.html">vec_coerce</a></span>(l, r, <span class="dt">.ptype =</span> <span class="kw">double</span>()))</a>
<a class="sourceLine" id="cb17-7" data-line-number="7">  <span class="kw">c</span>(l, r) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw"><a href="../reference/vec_recycle.html">vec_recycle</a></span>(l, r)</a>
<a class="sourceLine" id="cb17-8" data-line-number="8">  <span class="kw">c</span>(l, r) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">list</span>(<span class="kw">pmin</span>(l, r), <span class="kw">pmax</span>(l, r))</a>
<a class="sourceLine" id="cb17-9" data-line-number="9">  <span class="kw">new_interval</span>(l, r)</a>
<a class="sourceLine" id="cb17-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb17-11" data-line-number="11">format.vctrs_interval &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb17-12" data-line-number="12">  l &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"l"</span>)</a>
<a class="sourceLine" id="cb17-13" data-line-number="13">  r &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"r"</span>)</a>
<a class="sourceLine" id="cb17-14" data-line-number="14">  </a>
<a class="sourceLine" id="cb17-15" data-line-number="15">  out &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">"["</span>, <span class="kw">format</span>(l), <span class="st">","</span>, <span class="kw">format</span>(r), <span class="st">"]"</span>)</a>
<a class="sourceLine" id="cb17-16" data-line-number="16">  out[<span class="kw">is.na</span>(x)] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb17-17" data-line-number="17">  out</a>
<a class="sourceLine" id="cb17-18" data-line-number="18">}</a>
<a class="sourceLine" id="cb17-19" data-line-number="19"></a>
<a class="sourceLine" id="cb17-20" data-line-number="20">x &lt;-<span class="st"> </span><span class="kw">new_interval</span>(<span class="kw">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="ot">NA</span>), <span class="kw">c</span>(<span class="fl">0.5</span>, <span class="fl">1.5</span>, <span class="dv">2</span>, <span class="ot">NA</span>))</a>
<a class="sourceLine" id="cb17-21" data-line-number="21">x</a>
<a class="sourceLine" id="cb17-22" data-line-number="22"><span class="co">#&gt; &lt;vctrs_interval[4]&gt;</span></a>
<a class="sourceLine" id="cb17-23" data-line-number="23"><span class="co">#&gt; [1] [0.25,0.5] [0.50,1.5] [0.75,2.0] &lt;NA&gt;</span></a></code></pre></div>
<p>Arithmetic operations are provided by a single generic, <code><a href="../reference/vec_arith.html">vec_arith()</a></code>, which like <code><a href="../reference/vec_cast.html">vec_cast()</a></code> and <code><a href="../reference/vec_type2.html">vec_type2()</a></code>, uses double dispatch. That means we start with some boilerplate:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">vec_arith.vctrs_interval &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y) {</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">  <span class="kw">UseMethod</span>(<span class="st">"vec_arith.vctrs_interval"</span>, y)</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">vec_arith.vctrs_interval.default &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y) {</a>
<a class="sourceLine" id="cb18-5" data-line-number="5">  <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_op</a></span>(op, x, y)</a>
<a class="sourceLine" id="cb18-6" data-line-number="6">}</a></code></pre></div>
<p>First, we’ll implement a method two intervals. <a href="https://en.wikipedia.org/wiki/Interval_arithmetic#Simple_arithmetic" class="uri">https://en.wikipedia.org/wiki/Interval_arithmetic#Simple_arithmetic</a></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">vec_arith.vctrs_interval.vctrs_interval &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y) {</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">  <span class="kw">c</span>(x, y) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw"><a href="../reference/vec_recycle.html">vec_recycle</a></span>(x, y)</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb19-4" data-line-number="4">  x1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"l"</span>); x2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"r"</span>)</a>
<a class="sourceLine" id="cb19-5" data-line-number="5">  y1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fields.html">field</a></span>(y, <span class="st">"l"</span>); y2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fields.html">field</a></span>(y, <span class="st">"r"</span>)</a>
<a class="sourceLine" id="cb19-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb19-7" data-line-number="7">  <span class="cf">switch</span>(op,</a>
<a class="sourceLine" id="cb19-8" data-line-number="8">    <span class="st">"+"</span> =<span class="st"> </span><span class="kw">new_interval</span>(x1 <span class="op">+</span><span class="st"> </span>y1, x2 <span class="op">+</span><span class="st"> </span>y2),</a>
<a class="sourceLine" id="cb19-9" data-line-number="9">    <span class="st">"-"</span> =<span class="st"> </span><span class="kw">new_interval</span>(xl <span class="op">-</span><span class="st"> </span>y2, x2 <span class="op">-</span><span class="st"> </span>y1),</a>
<a class="sourceLine" id="cb19-10" data-line-number="10">    <span class="st">"*"</span> =<span class="st"> </span><span class="kw">new_interval</span>(</a>
<a class="sourceLine" id="cb19-11" data-line-number="11">      <span class="kw">pmin</span>(x1 <span class="op">*</span><span class="st"> </span>y1, x1 <span class="op">*</span><span class="st"> </span>y2, x2 <span class="op">*</span><span class="st"> </span>y1, x2 <span class="op">*</span><span class="st"> </span>y2), </a>
<a class="sourceLine" id="cb19-12" data-line-number="12">      <span class="kw">pmax</span>(x1 <span class="op">*</span><span class="st"> </span>y1, x1 <span class="op">*</span><span class="st"> </span>y2, x2 <span class="op">*</span><span class="st"> </span>y1, x2 <span class="op">*</span><span class="st"> </span>y2)</a>
<a class="sourceLine" id="cb19-13" data-line-number="13">    ),</a>
<a class="sourceLine" id="cb19-14" data-line-number="14">    <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_op</a></span>(op, x, y)</a>
<a class="sourceLine" id="cb19-15" data-line-number="15">  )</a>
<a class="sourceLine" id="cb19-16" data-line-number="16">}</a>
<a class="sourceLine" id="cb19-17" data-line-number="17"></a>
<a class="sourceLine" id="cb19-18" data-line-number="18">x <span class="op">+</span><span class="st"> </span><span class="kw">interval</span>(<span class="dv">0</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb19-19" data-line-number="19"><span class="co">#&gt; &lt;vctrs_interval[4]&gt;</span></a>
<a class="sourceLine" id="cb19-20" data-line-number="20"><span class="co">#&gt; [1] [0.25,1.5] [0.50,2.5] [0.75,3.0] &lt;NA&gt;</span></a>
<a class="sourceLine" id="cb19-21" data-line-number="21"></a>
<a class="sourceLine" id="cb19-22" data-line-number="22">x <span class="op">*</span><span class="st"> </span><span class="kw">interval</span>(<span class="dv">0</span>, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb19-23" data-line-number="23"><span class="co">#&gt; &lt;vctrs_interval[4]&gt;</span></a>
<a class="sourceLine" id="cb19-24" data-line-number="24"><span class="co">#&gt; [1] [ 0,0.5] [ 0,1.5] [ 0,2.0] &lt;NA&gt;</span></a>
<a class="sourceLine" id="cb19-25" data-line-number="25">x <span class="op">*</span><span class="st"> </span><span class="kw">interval</span>(<span class="dv">1</span>, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb19-26" data-line-number="26"><span class="co">#&gt; &lt;vctrs_interval[4]&gt;</span></a>
<a class="sourceLine" id="cb19-27" data-line-number="27"><span class="co">#&gt; [1] [0.25, 1] [0.50, 3] [0.75, 4] &lt;NA&gt;</span></a></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">vec_arith.vctrs_interval.double &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y) {</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">  <span class="kw">c</span>(x, y) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw"><a href="../reference/vec_recycle.html">vec_recycle</a></span>(x, y)</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb20-4" data-line-number="4">  l &lt;-<span class="st"> </span><span class="kw"><a href="../reference/vec_arith.html">vec_arith_base</a></span>(op, <span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"l"</span>), y)</a>
<a class="sourceLine" id="cb20-5" data-line-number="5">  r &lt;-<span class="st"> </span><span class="kw"><a href="../reference/vec_arith.html">vec_arith_base</a></span>(op, <span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"r"</span>), y)</a>
<a class="sourceLine" id="cb20-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb20-7" data-line-number="7">  <span class="kw">new_interval</span>(<span class="kw">pmin</span>(l, r), <span class="kw">pmax</span>(l, r))</a>
<a class="sourceLine" id="cb20-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb20-9" data-line-number="9"></a>
<a class="sourceLine" id="cb20-10" data-line-number="10">x <span class="op">+</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb20-11" data-line-number="11"><span class="co">#&gt; &lt;vctrs_interval[4]&gt;</span></a>
<a class="sourceLine" id="cb20-12" data-line-number="12"><span class="co">#&gt; [1] [1.25,1.5] [1.50,2.5] [1.75,3.0] &lt;NA&gt;</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13">x <span class="op">/</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb20-14" data-line-number="14"><span class="co">#&gt; &lt;vctrs_interval[4]&gt;</span></a>
<a class="sourceLine" id="cb20-15" data-line-number="15"><span class="co">#&gt; [1] [0.125,0.25] [0.250,0.75] [0.375,1.00] &lt;NA&gt;</span></a>
<a class="sourceLine" id="cb20-16" data-line-number="16">x <span class="op">*</span><span class="st"> </span><span class="dv">-2</span> </a>
<a class="sourceLine" id="cb20-17" data-line-number="17"><span class="co">#&gt; &lt;vctrs_interval[4]&gt;</span></a>
<a class="sourceLine" id="cb20-18" data-line-number="18"><span class="co">#&gt; [1] [-1,-0.5] [-3,-1.0] [-4,-1.5] &lt;NA&gt;</span></a></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">vec_arith.numeric.vctrs_interval &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y) {</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">  <span class="kw">c</span>(x, y) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw"><a href="../reference/vec_recycle.html">vec_recycle</a></span>(x, y)</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb21-4" data-line-number="4">  l &lt;-<span class="st"> </span><span class="kw"><a href="../reference/vec_arith.html">vec_arith_base</a></span>(op, x, <span class="kw"><a href="../reference/fields.html">field</a></span>(y, <span class="st">"l"</span>))</a>
<a class="sourceLine" id="cb21-5" data-line-number="5">  r &lt;-<span class="st"> </span><span class="kw"><a href="../reference/vec_arith.html">vec_arith_base</a></span>(op, x, <span class="kw"><a href="../reference/fields.html">field</a></span>(y, <span class="st">"r"</span>))</a>
<a class="sourceLine" id="cb21-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb21-7" data-line-number="7">  <span class="kw">new_interval</span>(<span class="kw">pmin</span>(l, r), <span class="kw">pmax</span>(l, r))</a>
<a class="sourceLine" id="cb21-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb21-9" data-line-number="9"></a>
<a class="sourceLine" id="cb21-10" data-line-number="10"><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb21-11" data-line-number="11"><span class="co">#&gt; &lt;vctrs_interval[4]&gt;</span></a>
<a class="sourceLine" id="cb21-12" data-line-number="12"><span class="co">#&gt; [1] [1.25,1.5] [1.50,2.5] [1.75,3.0] &lt;NA&gt;</span></a>
<a class="sourceLine" id="cb21-13" data-line-number="13"><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>x </a>
<a class="sourceLine" id="cb21-14" data-line-number="14"><span class="co">#&gt; &lt;vctrs_interval[4]&gt;</span></a>
<a class="sourceLine" id="cb21-15" data-line-number="15"><span class="co">#&gt; [1] [4.000000,8.000000] [1.333333,4.000000] [1.000000,2.666667]</span></a>
<a class="sourceLine" id="cb21-16" data-line-number="16"><span class="co">#&gt; [4] &lt;NA&gt;</span></a>
<a class="sourceLine" id="cb21-17" data-line-number="17"><span class="dv">-2</span> <span class="op">*</span><span class="st"> </span>x </a>
<a class="sourceLine" id="cb21-18" data-line-number="18"><span class="co">#&gt; &lt;vctrs_interval[4]&gt;</span></a>
<a class="sourceLine" id="cb21-19" data-line-number="19"><span class="co">#&gt; [1] [-1,-0.5] [-3,-1.0] [-4,-1.5] &lt;NA&gt;</span></a></code></pre></div>
<p>(Note that this implementation prevents subclassing because we explicitly call <code>new_interval()</code>. If you wanted to support subclassing, you’d need to carefully think about how to use <code><a href="../reference/vec_cast.html">vec_restore()</a></code>.)</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">vec_arith.vctrs_interval.MISSING &lt;-<span class="st"> </span><span class="cf">function</span>(op, x, y) {</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">  <span class="cf">switch</span>(op, </a>
<a class="sourceLine" id="cb22-3" data-line-number="3">    <span class="st">`</span><span class="dt">-</span><span class="st">`</span> =<span class="st"> </span>x <span class="op">*</span><span class="st"> </span><span class="dv">-1</span>,</a>
<a class="sourceLine" id="cb22-4" data-line-number="4">    <span class="st">`</span><span class="dt">+</span><span class="st">`</span> =<span class="st"> </span>x,</a>
<a class="sourceLine" id="cb22-5" data-line-number="5">    <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_op</a></span>(op, x, y)</a>
<a class="sourceLine" id="cb22-6" data-line-number="6">  )</a>
<a class="sourceLine" id="cb22-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb22-8" data-line-number="8"><span class="op">-</span>x </a>
<a class="sourceLine" id="cb22-9" data-line-number="9"><span class="co">#&gt; &lt;vctrs_interval[4]&gt;</span></a>
<a class="sourceLine" id="cb22-10" data-line-number="10"><span class="co">#&gt; [1] [-0.5,-0.25] [-1.5,-0.50] [-2.0,-0.75] &lt;NA&gt;</span></a>
<a class="sourceLine" id="cb22-11" data-line-number="11"><span class="op">+</span>x</a>
<a class="sourceLine" id="cb22-12" data-line-number="12"><span class="co">#&gt; &lt;vctrs_interval[4]&gt;</span></a>
<a class="sourceLine" id="cb22-13" data-line-number="13"><span class="co">#&gt; [1] [0.25,0.5] [0.50,1.5] [0.75,2.0] &lt;NA&gt;</span></a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#rational">Rational</a></li>
      <li><a href="#polynomial">Polynomial</a></li>
      <li><a href="#period-and-frequency">Period and frequency</a></li>
      <li><a href="#intervals">Intervals</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://hadley.nz">Hadley Wickham</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
