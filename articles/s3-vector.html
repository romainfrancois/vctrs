<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S3 vectors • vctrs</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="S3 vectors">
<meta property="og:description" content="">
<meta property="og:image" content="https://vctrs.r-lib.org/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vctrs</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/double-dispatch.html">Double dispatch</a>
    </li>
    <li>
      <a href="../articles/function-types.html">Function types</a>
    </li>
    <li>
      <a href="../articles/s3-base.html">Base classes</a>
    </li>
    <li>
      <a href="../articles/s3-proxy.html">Proxy generics</a>
    </li>
    <li>
      <a href="../articles/s3-vector.html">S3 vectors</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/vctrs">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>S3 vectors</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/vctrs/blob/master/vignettes/s3-vector.Rmd"><code>vignettes/s3-vector.Rmd</code></a></small>
      <div class="hidden name"><code>s3-vector.Rmd</code></div>

    </div>

    
    
<p>This vignette shows you how to create your own S3 vector classes. It focusses on the aspects of making a vector class that every class needs to worry about; you’ll also need to provide methods that actually make the vector useful.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(vctrs)</a></code></pre></div>
<p>This vignette will work through a few different types of vector:</p>
<ul>
<li><p>Perent: a simple class that changes the display of a numeric vector, but not its calculation. This will help you get familiar with the basics of vctrs. I recommend that every read this section, before picking up choosing from the following sections based on the type of vector you’ll need.</p></li>
<li><p>Decimal: a numeric class that always shows a fixed number of decimal places. We’ll store the number of decimal places in an attribute.</p></li>
<li><p>Cached sum: a numeric vector that caches the total sum in an attribute. This will show you how handle an attribute that is dependent on the data.</p></li>
<li><p>Rational: a pair of integer vectors that defines a rational number (i.e. a fraction).</p></li>
</ul>
<p>This vignette shows you the basic infrastructure for creating a new vector: defining low-level and user-facing constructor functions, providing a <code>format()</code> method, and defining casting and coercion methods. This gets you quite a long way because vctrs provides many S3 methods build from these primitives. For example:</p>
<ul>
<li><p><code>print()</code> and <code>str()</code> methods are defined in terms of <code>format()</code> so you get uniformly nice display as soon as you’ve made your <code>format()</code> method.</p></li>
<li><p>You can immediately put your new vector class in a data frame because vctrs provided the tricky <code>as.data.frame()</code> for you.</p></li>
<li><p>Subsetting (<code>[</code>, <code>[[</code>, <code>$</code>), <code>length&lt;-</code>, and <code>rep()</code> methods automatically preserve attributes because they’re built on top of <code><a href="../reference/vec_cast.html">vec_restore()</a></code>. A default <code><a href="../reference/vec_cast.html">vec_restore()</a></code> works for all classes where the attributes are data-independent, and can easily be customised when the attributes do depend on the data.</p></li>
<li><p>Subset-assignment methods (<code>[&lt;-</code>, <code>[[&lt;-</code>, <code>$&lt;-</code>) are implemented based on the principle that the new values should be coerced to the same type as the existing vector. This gives predictable behaviour and clear error messages.</p></li>
</ul>
<div id="percent" class="section level2">
<h2 class="hasAnchor">
<a href="#percent" class="anchor"></a>Percent</h2>
<p>In this section, I’ll show you how to make a “percent” class, i.e. a double vector that is printed like it’s a percentage. This is a good place to start because it’s the simplest possible S3 class as it has no custom attributes.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">percent</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co">#&gt; &lt;percent[3]&gt;</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co">#&gt; [1]   0%  50% 100%</span></a></code></pre></div>
<div id="low-level-constructor" class="section level3">
<h3 class="hasAnchor">
<a href="#low-level-constructor" class="anchor"></a>Low-level constructor</h3>
<p>All classes should have a low-level constructor called <code>new_class()</code> that checks types (but not values), then calls <code><a href="../reference/new_vctr.html">new_vctr()</a></code>. This function is designed for developers: it should be high performance so that it can be called from other functions.</p>
<p>The percent class is very simple, it’s constructor takes only a single input, which must be a double vector. Note that we prefix the name of the class with the name of the package. This prevents conflicting definitions between packages.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">new_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">  <span class="kw">stopifnot</span>(<span class="kw">is.double</span>(x))</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">  <span class="kw"><a href="../reference/new_vctr.html">new_vctr</a></span>(x, <span class="dt">class =</span> <span class="st">"vctrs_percent"</span>)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">x &lt;-<span class="st"> </span><span class="kw">new_percent</span>(<span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">length =</span> <span class="dv">4</span>), <span class="ot">NA</span>))</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">x</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt; &lt;vctrs_percent[5]&gt;</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#&gt; [1] 0.0000000 0.3333333 0.6666667 1.0000000        NA</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="kw">str</span>(x)</a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co">#&gt;  vctrs_pr [1:5] 0.0000000, 0.3333333, 0.6666667, 1.0000000,        NA</span></a></code></pre></div>
<p>If you want your class to be extensible, you need to include <code>...</code> and <code>class</code> in your low-level constructor:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">new_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, ..., <span class="dt">class =</span> <span class="kw">character</span>()) {</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="kw">stopifnot</span>(<span class="kw">is.double</span>(x))</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="kw"><a href="../reference/new_vctr.html">new_vctr</a></span>(x, ..., <span class="dt">class =</span> <span class="kw">c</span>(class, <span class="st">"vctrs_percent"</span>))</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">}</a></code></pre></div>
<p>You need to carefully decide if it’s worthwhile to make your class extensible, as it will make the implementation of other methods more complex, since you only know the inputs contain at least the specified attributes; they may contain more if it’s a subclass.</p>
</div>
<div id="format-method" class="section level3">
<h3 class="hasAnchor">
<a href="#format-method" class="anchor"></a><code>format()</code> method</h3>
<p>The first method for every class should almost always be a <code>format()</code> method. This should return a character vector the same length as <code>x</code>. The easiest way to do this is to rely on one of R’s low-level formatting functions like <code>formatC()</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">format.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  out &lt;-<span class="st"> </span><span class="kw">formatC</span>(<span class="kw">signif</span>(<span class="kw"><a href="../reference/vec_data.html">vec_data</a></span>(x) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>, <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  out[<span class="kw">is.na</span>(x)] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  out[<span class="op">!</span><span class="kw">is.na</span>(x)] &lt;-<span class="st"> </span><span class="kw">paste0</span>(out[<span class="op">!</span><span class="kw">is.na</span>(x)], <span class="st">"%"</span>)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  out</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">}</a></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">x</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co">#&gt; &lt;vctrs_percent[5]&gt;</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co">#&gt; [1] 0%    33.3% 66.7% 100%  &lt;NA&gt;</span></a></code></pre></div>
<p>(Note that we take a little care to not convert <code>NA</code> to <code>"NA"</code>; this leads to better printing.)</p>
<p>The format method is also used by data frames, tibbles, and <code>str()</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">data.frame</span>(x)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt;       x</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">#&gt; 1    0%</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">#&gt; 2 33.3%</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&gt; 3 66.7%</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&gt; 4  100%</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt; 5  &lt;NA&gt;</span></a></code></pre></div>
<p>For optimal display, I recommend also defining an abbreviated type name, which should be 4-5 letters for commonly used vectors. This is used in tibbles and in <code>str()</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">vec_ptype_abbr.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="st">"pcnt"</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">tibble<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/tibble/topics/tibble">tibble</a></span>(x)</a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co">#&gt; # A tibble: 5 x 1</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co">#&gt;        x</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="co">#&gt;   &lt;pcnt&gt;</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="co">#&gt; 1     0%</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="co">#&gt; 2  33.3%</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="co">#&gt; 3  66.7%</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="co">#&gt; 4   100%</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="co">#&gt; 5     NA</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"></a>
<a class="sourceLine" id="cb8-15" data-line-number="15"><span class="kw">str</span>(x)</a>
<a class="sourceLine" id="cb8-16" data-line-number="16"><span class="co">#&gt;  pcnt [1:5] 0%, 33.3%, 66.7%, 100%, &lt;NA&gt;</span></a></code></pre></div>
<p>If you need more control over printing in tibbles, implement a method for <code><a href="http://www.rdocumentation.org/packages/pillar/topics/pillar_shaft">pillar::pillar_shaft()</a></code>. See <a href="https://tibble.tidyverse.org/articles/extending.html" class="uri">https://tibble.tidyverse.org/articles/extending.html</a> for details.</p>
</div>
<div id="default-methods" class="section level3">
<h3 class="hasAnchor">
<a href="#default-methods" class="anchor"></a>Default methods</h3>
<p>The vctr base class provides implementations of many important generics so that you don’t have to. This means that many functions will work out of the box without any additional effort on your part:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">x[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co">#&gt; &lt;vctrs_percent[2]&gt;</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co">#&gt; [1] 0%    33.3%</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">x[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">#&gt; &lt;vctrs_percent[1]&gt;</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co">#&gt; [1] 0%</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="kw">sqrt</span>(x)</a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co">#&gt; &lt;vctrs_percent[5]&gt;</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="co">#&gt; [1] 0%    57.7% 81.6% 100%  &lt;NA&gt;</span></a></code></pre></div>
</div>
<div id="user-friendly-constructor" class="section level3">
<h3 class="hasAnchor">
<a href="#user-friendly-constructor" class="anchor"></a>User-friendly constructor</h3>
<p>Next, implement a user friendly constructor called <code>myclass()</code>. It should carefully check that the input is valid and provide human readable messages. This constructor will typically use <code><a href="../reference/vec_cast.html">vec_cast()</a></code> to helpfully coerce inputs to the correct type.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">percent &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">x =</span> <span class="kw">double</span>()) {</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(x, <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">  <span class="kw">new_percent</span>(x)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">}</a></code></pre></div>
<p>Before you go on, check that user-friendly constructor returns a zero-length vector when called with no arguments. This makes it easy to use as a prototype.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">percent</span>()</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co">#&gt; &lt;vctrs_percent[0]&gt;</span></a></code></pre></div>
</div>
<div id="casting" class="section level3">
<h3 class="hasAnchor">
<a href="#casting" class="anchor"></a>Casting</h3>
<p>Next, define possible casts between your vector and existing types. You do this by providing methods for <code><a href="../reference/vec_cast.html">vec_cast()</a></code>. <code><a href="../reference/vec_cast.html">vec_cast()</a></code> is a little unusual because the result depends on the type of both arguments: the input <code>x</code>, and the target type <code>to</code>. Techically, this means that we need <strong>double dispatch</strong>, which is described in detail in <code><a href="../articles/double-dispatch.html">vignette("double-dispatch")</a></code>. S3 does not natively support double dispatch, but we can implement with a trick: doing single dispatch twice. Here we’ll focus on the practicalities, giving you a recipe to follow for your class.</p>
<p>First, we create a new generic, and provide two standard methods:</p>
<ul>
<li><p><code>vec_cast.vctrs_percent.default()</code> ensures that the default behaviour is to throw an informative error message.</p></li>
<li><p><code>vec_cast.vctrs_percent.logical()</code> ensures that you class works when combined with <code>NA</code>. Technically, NA has class logical, but we want to be able to use it as a type-less specifier that works with all vectors.</p></li>
</ul>
<p>These are required for every class; you can just copy and paste this block, replacing <code>percent</code> with the name of your class.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">vec_cast.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw">UseMethod</span>(<span class="st">"vec_cast.vctrs_percent"</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">vec_cast.vctrs_percent.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_cast</a></span>(x, to)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">vec_cast.vctrs_percent.logical &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw"><a href="../reference/unspecified.html">vec_unspecified_cast</a></span>(x, to)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="kw">character</span>(), x)</a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="co">#&gt; Error: Can't cast &lt;character&gt; to &lt;vctrs_percent&gt;</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co">#&gt; Call `rlang::last_error()` to see a backtrace</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="ot">NA</span>, <span class="kw">percent</span>())</a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="co">#&gt; &lt;vctrs_percent[1]&gt;</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="co">#&gt; [1] &lt;NA&gt;</span></a></code></pre></div>
<p>You also need to provide a method to coerce one percent object to match the attributes of another. This is very simple because percent objects have no attributes, but it will more complicated for more complex object types.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">vec_cast.vctrs_percent.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) x</a></code></pre></div>
<p>Next we provide some useful methods to coerce percents back and forth with doubles:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">vec_cast.vctrs_percent.double &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw">percent</span>(x)</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">vec_cast.double.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw"><a href="../reference/vec_data.html">vec_data</a></span>(x)</a>
<a class="sourceLine" id="cb14-3" data-line-number="3"></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="fl">0.5</span>, <span class="kw">percent</span>())</a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="co">#&gt; &lt;vctrs_percent[1]&gt;</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="co">#&gt; [1] 50%</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="kw">percent</span>(<span class="fl">0.5</span>), <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="co">#&gt; [1] 0.5</span></a></code></pre></div>
<p>And then with integers. Note that I use <code><a href="../reference/vec_cast.html">vec_cast()</a></code> on the underlying vector (<code><a href="../reference/vec_data.html">vec_data()</a></code>) in order to get the nice default behaviour which reports when we lose precision:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">vec_cast.vctrs_percent.integer &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw">percent</span>(x <span class="op">/</span><span class="st"> </span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">vec_cast.integer.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="kw"><a href="../reference/vec_data.html">vec_data</a></span>(x) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>, <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="kw">c</span>(100L, 50L), <span class="kw">percent</span>())</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co">#&gt; &lt;vctrs_percent[2]&gt;</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="co">#&gt; [1] 100% 50%</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="kw">percent</span>(<span class="kw">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>)), <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="co">#&gt; [1]  50 100</span></a></code></pre></div>
<p>These methods power <code>[[&lt;-</code> and <code>[&lt;-</code>, because the vctrs default coerces the <code>value</code> to the same type as <code>x</code>.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">x[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">x</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="co">#&gt; &lt;vctrs_percent[5]&gt;</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="co">#&gt; [1] 200%  33.3% 66.7% 100%  &lt;NA&gt;</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5"></a>
<a class="sourceLine" id="cb16-6" data-line-number="6">x[[<span class="dv">1</span>]] &lt;-<span class="st"> "x"</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="co">#&gt; Error: Can't cast &lt;character&gt; to &lt;vctrs_percent&gt;</span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="co">#&gt; Call `rlang::last_error()` to see a backtrace</span></a></code></pre></div>
</div>
<div id="coercion" class="section level3">
<h3 class="hasAnchor">
<a href="#coercion" class="anchor"></a>Coercion</h3>
<p>Finally, we define methods for <code><a href="../reference/vec_type2.html">vec_type2()</a></code> which tells vctrs when it is ok to perform automatic (aka implicit) coercion: given a pair of prototypes, it should either return their common type or throw an error.</p>
<p><code><a href="../reference/vec_type2.html">vec_type2()</a></code> also uses double-dispatch, so we start off with a recipe:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">vec_type2.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">UseMethod</span>(<span class="st">"vec_type2.vctrs_percent"</span>)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">vec_type2.vctrs_percent.default           &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_type</a></span>(x, y)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">vec_type2.vctrs_percent.vctrs_unspecified &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) x</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">vec_type2.vctrs_percent.vctrs_percent     &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) x</a></code></pre></div>
<p>Next we define methods that say it’s ok to automatically coerce percents to double and integer vectors.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">vec_type2.vctrs_percent.double  &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">percent</span>()</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">vec_type2.double.vctrs_percent  &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">percent</span>()</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">vec_type2.vctrs_percent.integer &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">percent</span>()</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">vec_type2.integer.vctrs_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">percent</span>()</a></code></pre></div>
<p>If you’re unsure about what methods to provide here, err on the side of caution: too many implicit coercions make code hard to understand.</p>
<p>Implementing casting gives you more methods for free:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw"><a href="../reference/vec_c.html">vec_c</a></span>(x, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="co">#&gt; &lt;vctrs_percent[6]&gt;</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="co">#&gt; [1] 200%  33.3% 66.7% 100%  &lt;NA&gt;  100%</span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4"></a>
<a class="sourceLine" id="cb19-5" data-line-number="5">x[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">1</span></a></code></pre></div>
<p>However, you can assume any function beginning with <code>vec()</code> will handle these coercions correctly.</p>
</div>
</div>
<div id="decimal" class="section level2">
<h2 class="hasAnchor">
<a href="#decimal" class="anchor"></a>Decimal</h2>
<p>Now that you’ve seen the basics with a very simple S3 class, we’ll gradually explore more complicated scenarios. This section creates a <code>decimal</code> class that always prints with the specified number of decimal places. This is very similar to <code>percent</code> but now the class needs an attribute: the number of decimal places to display.</p>
<p>We start of as before, defining a low-level constructor, a user-friendly constructor, a <code>format()</code> method, and a <code><a href="../reference/vec_ptype_full.html">vec_ptype_abbr()</a></code>. Note that additional object attributes are simply passed along to <code><a href="../reference/new_vctr.html">new_vctr()</a></code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">new_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">x =</span> <span class="kw">double</span>(), <span class="dt">digits =</span> 2L) {</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">  <span class="kw">stopifnot</span>(<span class="kw">is.double</span>(x))</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">  <span class="kw">stopifnot</span>(<span class="kw">is.integer</span>(digits), <span class="kw">length</span>(digits) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb20-5" data-line-number="5">  <span class="kw"><a href="../reference/new_vctr.html">new_vctr</a></span>(x, <span class="dt">digits =</span> digits, <span class="dt">class =</span> <span class="st">"vctrs_decimal"</span>)</a>
<a class="sourceLine" id="cb20-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb20-7" data-line-number="7"></a>
<a class="sourceLine" id="cb20-8" data-line-number="8">decimal &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">x =</span> <span class="kw">double</span>(), <span class="dt">digits =</span> 2L) {</a>
<a class="sourceLine" id="cb20-9" data-line-number="9">  x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(x, <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb20-10" data-line-number="10">  digits &lt;-<span class="st"> </span><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(digits, <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb20-11" data-line-number="11">  <span class="cf">if</span> (<span class="kw">length</span>(digits) <span class="op">!=</span><span class="st"> </span><span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb20-12" data-line-number="12">    <span class="kw">stop</span>(<span class="st">"`digits` must be length 1"</span>, <span class="dt">call. =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb20-13" data-line-number="13">  }</a>
<a class="sourceLine" id="cb20-14" data-line-number="14">  </a>
<a class="sourceLine" id="cb20-15" data-line-number="15">  <span class="kw">new_decimal</span>(x, <span class="dt">digits =</span> digits)</a>
<a class="sourceLine" id="cb20-16" data-line-number="16">}</a>
<a class="sourceLine" id="cb20-17" data-line-number="17"></a>
<a class="sourceLine" id="cb20-18" data-line-number="18">digits &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">attr</span>(x, <span class="st">"digits"</span>)</a>
<a class="sourceLine" id="cb20-19" data-line-number="19"></a>
<a class="sourceLine" id="cb20-20" data-line-number="20">format.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb20-21" data-line-number="21">  <span class="kw">sprintf</span>(<span class="kw">paste0</span>(<span class="st">"%-0."</span>, <span class="kw">digits</span>(x), <span class="st">"f"</span>), x)</a>
<a class="sourceLine" id="cb20-22" data-line-number="22">}</a>
<a class="sourceLine" id="cb20-23" data-line-number="23"></a>
<a class="sourceLine" id="cb20-24" data-line-number="24">vec_ptype_abbr.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb20-25" data-line-number="25">  <span class="kw">paste0</span>(<span class="st">"dec"</span>)</a>
<a class="sourceLine" id="cb20-26" data-line-number="26">}</a>
<a class="sourceLine" id="cb20-27" data-line-number="27"></a>
<a class="sourceLine" id="cb20-28" data-line-number="28">x &lt;-<span class="st"> </span><span class="kw">decimal</span>(<span class="kw">runif</span>(<span class="dv">10</span>), 1L)</a>
<a class="sourceLine" id="cb20-29" data-line-number="29">x</a>
<a class="sourceLine" id="cb20-30" data-line-number="30"><span class="co">#&gt; &lt;vctrs_decimal[10]&gt;</span></a>
<a class="sourceLine" id="cb20-31" data-line-number="31"><span class="co">#&gt;  [1] 0.1 0.8 0.6 0.2 0.0 0.5 0.5 0.3 0.7 0.8</span></a></code></pre></div>
<p>Note that I provide a little helper to extract the <code>digits</code> attribute. This makes the code a little easier to read, and should not be exported.</p>
<p>By default, vctrs assumes that attributes are independent of the data, and so are automatically preserved. You’ll see what to do if the attributes are data dependent in the next section.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">x[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="co">#&gt; &lt;vctrs_decimal[2]&gt;</span></a>
<a class="sourceLine" id="cb21-3" data-line-number="3"><span class="co">#&gt; [1] 0.1 0.8</span></a>
<a class="sourceLine" id="cb21-4" data-line-number="4">x[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb21-5" data-line-number="5"><span class="co">#&gt; &lt;vctrs_decimal[1]&gt;</span></a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="co">#&gt; [1] 0.1</span></a></code></pre></div>
<p>For the sake of exposition, we’ll assume that <code>digits</code> is an important attribute of the class, and should be included in the full type:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">vec_ptype_full.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">  <span class="kw">paste0</span>(<span class="st">"decimal&lt;"</span>, <span class="kw">digits</span>(x), <span class="st">"&gt;"</span>)</a>
<a class="sourceLine" id="cb22-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb22-4" data-line-number="4"></a>
<a class="sourceLine" id="cb22-5" data-line-number="5">x</a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="co">#&gt; &lt;decimal&lt;1&gt;[10]&gt;</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="co">#&gt;  [1] 0.1 0.8 0.6 0.2 0.0 0.5 0.5 0.3 0.7 0.8</span></a></code></pre></div>
<p>Now consider <code><a href="../reference/vec_cast.html">vec_cast()</a></code> and <code><a href="../reference/vec_type2.html">vec_type2()</a></code>. I start with the standard recipes:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">vec_type2.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">UseMethod</span>(<span class="st">"vec_type2.vctrs_decimal"</span>)</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">vec_type2.vctrs_decimal.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_type</a></span>(x, y)</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">vec_type2.vctrs_decimal.vctrs_unspecified &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) x</a>
<a class="sourceLine" id="cb23-4" data-line-number="4"></a>
<a class="sourceLine" id="cb23-5" data-line-number="5">vec_cast.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw">UseMethod</span>(<span class="st">"vec_cast.vctrs_decimal"</span>)</a>
<a class="sourceLine" id="cb23-6" data-line-number="6">vec_cast.vctrs_decimal.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_cast</a></span>(x, to)</a>
<a class="sourceLine" id="cb23-7" data-line-number="7">vec_cast.vctrs_decimal.logical &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw"><a href="../reference/unspecified.html">vec_unspecified_cast</a></span>(x, to)</a></code></pre></div>
<p>Casting and coercing from one decimal to another requires a little thought as the values of the <code>digits</code> attribute might be different, and we need some way to reconcile them. Here I’ve chosen to chose the maximum of the two, but for your class you might chose the left-hand side or throw an error.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">vec_type2.vctrs_decimal.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb24-2" data-line-number="2">  <span class="kw">new_decimal</span>(<span class="dt">digits =</span> <span class="kw">max</span>(<span class="kw">digits</span>(x), <span class="kw">digits</span>(y)))</a>
<a class="sourceLine" id="cb24-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb24-4" data-line-number="4">vec_cast.vctrs_decimal.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) {</a>
<a class="sourceLine" id="cb24-5" data-line-number="5">  <span class="kw">new_decimal</span>(<span class="kw"><a href="../reference/vec_data.html">vec_data</a></span>(x), <span class="dt">digits =</span> <span class="kw">digits</span>(to))</a>
<a class="sourceLine" id="cb24-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb24-7" data-line-number="7"></a>
<a class="sourceLine" id="cb24-8" data-line-number="8"><span class="kw"><a href="../reference/vec_c.html">vec_c</a></span>(<span class="kw">decimal</span>(<span class="dv">1</span><span class="op">/</span><span class="dv">100</span>, <span class="dt">digits =</span> <span class="dv">3</span>), <span class="kw">decimal</span>(<span class="dv">2</span><span class="op">/</span><span class="dv">100</span>, <span class="dt">digits =</span> <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb24-9" data-line-number="9"><span class="co">#&gt; &lt;decimal&lt;3&gt;[2]&gt;</span></a>
<a class="sourceLine" id="cb24-10" data-line-number="10"><span class="co">#&gt; [1] 0.010 0.020</span></a></code></pre></div>
<p>Finally, I can implement coercion to and from other types, like doubles. When automatically coercing, I choose the richer type (i.e. the decimal).</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">vec_type2.vctrs_decimal.double &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) x</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">vec_type2.double.vctrs_decimal &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) y</a>
<a class="sourceLine" id="cb25-3" data-line-number="3"></a>
<a class="sourceLine" id="cb25-4" data-line-number="4">vec_cast.vctrs_decimal.double  &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw">new_decimal</span>(x, <span class="dt">digits =</span> <span class="kw">digits</span>(to))</a>
<a class="sourceLine" id="cb25-5" data-line-number="5">vec_cast.double.vctrs_decimal  &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw"><a href="../reference/vec_data.html">vec_data</a></span>(x)</a>
<a class="sourceLine" id="cb25-6" data-line-number="6"></a>
<a class="sourceLine" id="cb25-7" data-line-number="7"><span class="kw"><a href="../reference/vec_c.html">vec_c</a></span>(<span class="kw">decimal</span>(<span class="dv">1</span>, <span class="dt">digits =</span> <span class="dv">1</span>), pi)</a>
<a class="sourceLine" id="cb25-8" data-line-number="8"><span class="co">#&gt; &lt;decimal&lt;1&gt;[2]&gt;</span></a>
<a class="sourceLine" id="cb25-9" data-line-number="9"><span class="co">#&gt; [1] 1.0 3.1</span></a>
<a class="sourceLine" id="cb25-10" data-line-number="10"><span class="kw"><a href="../reference/vec_c.html">vec_c</a></span>(pi, <span class="kw">decimal</span>(<span class="dv">1</span>, <span class="dt">digits =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb25-11" data-line-number="11"><span class="co">#&gt; &lt;decimal&lt;1&gt;[2]&gt;</span></a>
<a class="sourceLine" id="cb25-12" data-line-number="12"><span class="co">#&gt; [1] 3.1 1.0</span></a></code></pre></div>
</div>
<div id="cached-sum" class="section level2">
<h2 class="hasAnchor">
<a href="#cached-sum" class="anchor"></a>Cached sum</h2>
<p>The next level up in complexity is an object that has data-dependent attributes. To explore this idea we’ll create a vector that caches the sum of its values. As usual, we start with low-level and user-friendly constructors:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1">new_cached_sum &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">x =</span> <span class="kw">double</span>(), <span class="dt">sum =</span> 0L) {</a>
<a class="sourceLine" id="cb26-2" data-line-number="2">  <span class="kw">stopifnot</span>(<span class="kw">is.double</span>(x))</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">  <span class="kw">stopifnot</span>(<span class="kw">is.double</span>(sum), <span class="kw">length</span>(sum) <span class="op">==</span><span class="st"> </span>1L)</a>
<a class="sourceLine" id="cb26-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb26-5" data-line-number="5">  <span class="kw"><a href="../reference/new_vctr.html">new_vctr</a></span>(x, <span class="dt">sum =</span> sum, <span class="dt">class =</span> <span class="st">"vctrs_cached_sum"</span>)</a>
<a class="sourceLine" id="cb26-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb26-7" data-line-number="7"></a>
<a class="sourceLine" id="cb26-8" data-line-number="8">cached_sum &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb26-9" data-line-number="9">  x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(x, <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb26-10" data-line-number="10">  <span class="kw">new_cached_sum</span>(x, <span class="kw">sum</span>(x))</a>
<a class="sourceLine" id="cb26-11" data-line-number="11">}</a></code></pre></div>
<p>For this class, we don’t need to provide a method for <code>format()</code>. Instead, we’ll provide a method for <code><a href="../reference/vec_print.html">vec_print_footer()</a></code> that prints the sum:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">vec_print_footer.vctrs_cached_sum &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">  <span class="kw">cat</span>(<span class="st">"# Sum: "</span>, <span class="kw">format</span>(<span class="kw">attr</span>(x, <span class="st">"sum"</span>), <span class="dt">digits =</span> <span class="dv">3</span>), <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, <span class="dt">sep =</span> <span class="st">""</span>)</a>
<a class="sourceLine" id="cb27-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb27-4" data-line-number="4"></a>
<a class="sourceLine" id="cb27-5" data-line-number="5">x &lt;-<span class="st"> </span><span class="kw">cached_sum</span>(<span class="kw">runif</span>(<span class="dv">10</span>))</a>
<a class="sourceLine" id="cb27-6" data-line-number="6">x</a>
<a class="sourceLine" id="cb27-7" data-line-number="7"><span class="co">#&gt; &lt;vctrs_cached_sum[10]&gt;</span></a>
<a class="sourceLine" id="cb27-8" data-line-number="8"><span class="co">#&gt;  [1] 0.87460066 0.17494063 0.03424133 0.32038573 0.40232824 0.19566983</span></a>
<a class="sourceLine" id="cb27-9" data-line-number="9"><span class="co">#&gt;  [7] 0.40353812 0.06366146 0.38870131 0.97554784</span></a>
<a class="sourceLine" id="cb27-10" data-line-number="10"><span class="co">#&gt; # Sum: 3.83</span></a></code></pre></div>
<p>As mentioned above, vctrs assumes that attributes are independent of the data. This means that when we take advantage of the default methods, they’ll work, but return the incorrect result:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">x[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="cb28-2" data-line-number="2"><span class="co">#&gt; &lt;vctrs_cached_sum[2]&gt;</span></a>
<a class="sourceLine" id="cb28-3" data-line-number="3"><span class="co">#&gt; [1] 0.8746007 0.1749406</span></a>
<a class="sourceLine" id="cb28-4" data-line-number="4"><span class="co">#&gt; # Sum: 3.83</span></a></code></pre></div>
<p>To fix this, you need to provide a <code><a href="../reference/vec_cast.html">vec_restore()</a></code> method. Note that this method dispatches on the <code>to</code> argument.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">vec_restore.vctrs_cached_sum &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) {</a>
<a class="sourceLine" id="cb29-2" data-line-number="2">  <span class="kw">new_cached_sum</span>(x, <span class="kw">sum</span>(x))</a>
<a class="sourceLine" id="cb29-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb29-4" data-line-number="4"></a>
<a class="sourceLine" id="cb29-5" data-line-number="5">x[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb29-6" data-line-number="6"><span class="co">#&gt; &lt;vctrs_cached_sum[1]&gt;</span></a>
<a class="sourceLine" id="cb29-7" data-line-number="7"><span class="co">#&gt; [1] 0.8746007</span></a>
<a class="sourceLine" id="cb29-8" data-line-number="8"><span class="co">#&gt; # Sum: 0.875</span></a></code></pre></div>
<p>This works because most of the vctrs methods dispatch to the underlying base function, by first stripping off extra attributes with <code><a href="../reference/vec_data.html">vec_data()</a></code> and then reapplying them again with <code><a href="../reference/vec_cast.html">vec_restore()</a></code>. The default <code><a href="../reference/vec_cast.html">vec_restore()</a></code> method copies over all attributes, which is not appropriate here.</p>
<p>Note that <code>vec_restore.class</code> is subtly different from <code>vec_cast.class.class()</code>. <code><a href="../reference/vec_cast.html">vec_restore()</a></code> is used when restoring attributes that have been lost; <code><a href="../reference/vec_cast.html">vec_cast()</a></code> is used for coercions. This is easier to understand with a concrete example. Imagine factors were implements with <code>new_vectr()</code>. <code>vec_restore.factor()</code> would restore attributes back to an integer vector, but you would not want to allow manually casting an integer to a factor with <code><a href="../reference/vec_cast.html">vec_cast()</a></code>.</p>
</div>
<div id="rational" class="section level1">
<h1 class="hasAnchor">
<a href="#rational" class="anchor"></a>Rational</h1>
<p>A fraction, or rational number can be represented by a pair of integer vectors representing the numerator (the number on top) and the denominator (the number on bottom), where the length of each vector must be the same. To represent such a data structure we turn to a new base data type: the record (or rcrd for short).</p>
<p>As usual we start with low-level and user-friendly constructors. The low-level constructor calls <code><a href="../reference/new_rcrd.html">new_rcrd()</a></code> which expects a named list of equal-length vectors (and will error if given anything else).</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">new_rational &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">n =</span> <span class="kw">integer</span>(), <span class="dt">d =</span> <span class="kw">integer</span>()) {</a>
<a class="sourceLine" id="cb30-2" data-line-number="2">  <span class="kw">stopifnot</span>(<span class="kw">is.integer</span>(n))</a>
<a class="sourceLine" id="cb30-3" data-line-number="3">  <span class="kw">stopifnot</span>(<span class="kw">is.integer</span>(d))</a>
<a class="sourceLine" id="cb30-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb30-5" data-line-number="5">  <span class="kw"><a href="../reference/new_rcrd.html">new_rcrd</a></span>(<span class="kw">list</span>(<span class="dt">n =</span> n, <span class="dt">d =</span> d), <span class="dt">class =</span> <span class="st">"vctrs_rational"</span>)</a>
<a class="sourceLine" id="cb30-6" data-line-number="6">}</a></code></pre></div>
<p>In our user friendly constructor as well as casting <code>n</code> and <code>d</code> to the desired type, we also recycle them to the same length.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">rational &lt;-<span class="st"> </span><span class="cf">function</span>(n, d) {</a>
<a class="sourceLine" id="cb31-2" data-line-number="2">  <span class="kw">c</span>(n, d) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">as.list</span>(<span class="kw"><a href="../reference/vec_coerce.html">vec_coerce</a></span>(n, d, <span class="dt">.ptype =</span> <span class="kw">integer</span>()))</a>
<a class="sourceLine" id="cb31-3" data-line-number="3">  <span class="kw">c</span>(n, d) <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw"><a href="../reference/vec_recycle.html">vec_recycle</a></span>(n, d)</a>
<a class="sourceLine" id="cb31-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb31-5" data-line-number="5">  <span class="kw">new_rational</span>(n, d)</a>
<a class="sourceLine" id="cb31-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb31-7" data-line-number="7"></a>
<a class="sourceLine" id="cb31-8" data-line-number="8">x &lt;-<span class="st"> </span><span class="kw">rational</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a></code></pre></div>
<p>Behind the scenes, <code>x</code> is a named list with two elements. But to behave like a vector, those details are hidden:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="kw">names</span>(x)</a>
<a class="sourceLine" id="cb32-2" data-line-number="2"><span class="co">#&gt; NULL</span></a>
<a class="sourceLine" id="cb32-3" data-line-number="3"><span class="kw">length</span>(x)</a>
<a class="sourceLine" id="cb32-4" data-line-number="4"><span class="co">#&gt; [1] 10</span></a></code></pre></div>
<p>To access the underlyings we need to use <code><a href="../reference/fields.html">field()</a></code> and <code><a href="../reference/fields.html">fields()</a></code>:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="kw"><a href="../reference/fields.html">fields</a></span>(x)</a>
<a class="sourceLine" id="cb33-2" data-line-number="2"><span class="co">#&gt; [1] "n" "d"</span></a>
<a class="sourceLine" id="cb33-3" data-line-number="3"><span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"n"</span>)</a>
<a class="sourceLine" id="cb33-4" data-line-number="4"><span class="co">#&gt;  [1] 1 1 1 1 1 1 1 1 1 1</span></a></code></pre></div>
<p>Which allows us to create a format method:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">format.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb34-2" data-line-number="2">  n &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"n"</span>)</a>
<a class="sourceLine" id="cb34-3" data-line-number="3">  d &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fields.html">field</a></span>(x, <span class="st">"d"</span>)</a>
<a class="sourceLine" id="cb34-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb34-5" data-line-number="5">  out &lt;-<span class="st"> </span><span class="kw">paste0</span>(n, <span class="st">"/"</span>, d)</a>
<a class="sourceLine" id="cb34-6" data-line-number="6">  out[<span class="kw">is.na</span>(n) <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(d)] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb34-7" data-line-number="7">  </a>
<a class="sourceLine" id="cb34-8" data-line-number="8">  out</a>
<a class="sourceLine" id="cb34-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb34-10" data-line-number="10"></a>
<a class="sourceLine" id="cb34-11" data-line-number="11">vec_ptype_abbr.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="st">"rtnl"</span></a>
<a class="sourceLine" id="cb34-12" data-line-number="12">vec_ptype_full.vctrs_rational &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="st">"rational"</span></a>
<a class="sourceLine" id="cb34-13" data-line-number="13"></a>
<a class="sourceLine" id="cb34-14" data-line-number="14">x</a>
<a class="sourceLine" id="cb34-15" data-line-number="15"><span class="co">#&gt; &lt;rational[10]&gt;</span></a>
<a class="sourceLine" id="cb34-16" data-line-number="16"><span class="co">#&gt;  [1] 1/1  1/2  1/3  1/4  1/5  1/6  1/7  1/8  1/9  1/10</span></a></code></pre></div>
<p>vctrs also uses this method in <code>str()</code>, hiding the underlying implementation details from the user:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="kw">str</span>(x)</a>
<a class="sourceLine" id="cb35-2" data-line-number="2"><span class="co">#&gt;  rtnl [1:10] 1/1, 1/2, 1/3, 1/4, 1/5, 1/6, 1/7, 1/8, 1/9, 1/10</span></a></code></pre></div>
<p>Implementing <code><a href="../reference/vec_ptype.html">vec_ptype()</a></code> and <code><a href="../reference/vec_cast.html">vec_cast()</a></code> is straightforward following the existing recipes of <code>percent()</code>. If the class has additional attributes, follow the recipe of <code>decimal()</code>. If the attributes, vary based on the data, follow the recipe of <code>cached_sum()</code>.</p>
<div id="general-considerations" class="section level2">
<h2 class="hasAnchor">
<a href="#general-considerations" class="anchor"></a>General considerations</h2>
<div id="coercions" class="section level3">
<h3 class="hasAnchor">
<a href="#coercions" class="anchor"></a>Coercions</h3>
<p><code><a href="../reference/vec_type2.html">vec_type2()</a></code> defines the possible set of automatic (implicit) coercions. These coercions happen silently, so they should be quite strict; if they’re too flexible, they increase the chance of silently propagating mistakes. To think about what coercions your class should provide, it’s useful to look at coercions that vctrs provides for base types:</p>
<p><img src="../man/figures/coerce.png"><!-- --></p>
<p>If you squint your brain a little, I think you can see that each set of automatic coercions is about increasing resolution. Integers are low resolution versions of doubles, and dates are low resolution versions of date-times. Logicals are low resolution version of integers because there’s a strong convention that <code>TRUE</code> and <code>FALSE</code> can be used interchangeably with <code>1</code> and <code>0</code>.</p>
<p>But what is the resolution of a factor? We must take a somewhat pragmatic approach because base R often converts character vectors to factors, and we don’t want to be burdensome to users. So we say that a factor <code>x</code> has finer resolution than factor <code>y</code> if the levels of <code>y</code> are contained in <code>x</code>. So to find the common type of two factors, we take the union of the levels of both factors, resulting in a factor that has finer resolution than either. Finally, you can think of a character vector as a factor with every possible level, so factors and character vectors are coercible.</p>
<p>I expect that most custom classes will be coercible to only a couple of other classes at most.</p>
</div>
<div id="casts" class="section level3">
<h3 class="hasAnchor">
<a href="#casts" class="anchor"></a>Casts</h3>
<p><code><a href="../reference/vec_cast.html">vec_cast()</a></code> defines the possible set user-requested coercions, known as <strong>casts</strong>. Because these are user initiated, the set of possible casts is much larger than the set of possible coercions. The following diagram shows the set of casts that vctrs provides for base classes. If you can follow arrows in the same direction from one class to another, then a cast exists.</p>
<p><img src="../man/figures/cast.png"><!-- --></p>
<p>Note that the arrows are bidirectional: if you can cast from <code>x</code> to <code>y</code>, you should also be able to cast back from <code>y</code> to <code>x</code>.</p>
<p>If type <code>x</code> has greater resolution than <code>y</code>, there will be some inputs that lose precision. These should generate warnings using <code><a href="../reference/vctrs-conditions.html">warn_lossy_cast()</a></code>. You can see that in action when casting from doubles to integers; only some doubles can become integers without losing resolution.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">10</span>), <span class="dt">to =</span> <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb36-2" data-line-number="2"><span class="co">#&gt; [1]  1  2 10</span></a>
<a class="sourceLine" id="cb36-3" data-line-number="3"></a>
<a class="sourceLine" id="cb36-4" data-line-number="4"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="kw">c</span>(<span class="fl">1.5</span>, <span class="dv">2</span>, <span class="fl">10.5</span>), <span class="dt">to =</span> <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb36-5" data-line-number="5"><span class="co">#&gt; Warning: Lossy cast from &lt;double&gt; to &lt;integer&gt;</span></a>
<a class="sourceLine" id="cb36-6" data-line-number="6"><span class="co">#&gt; Locations: 1, 3</span></a>
<a class="sourceLine" id="cb36-7" data-line-number="7"><span class="co">#&gt; [1]  1  2 10</span></a></code></pre></div>
<p>Generally, you should provide a cast method whenever it’s meaningful to cast back and forth from a given type.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#percent">Percent</a></li>
      <li><a href="#decimal">Decimal</a></li>
      <li><a href="#cached-sum">Cached sum</a></li>
      <li>
<a href="#rational">Rational</a><ul class="nav nav-pills nav-stacked">
<li><a href="#general-considerations">General considerations</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://hadley.nz">Hadley Wickham</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
